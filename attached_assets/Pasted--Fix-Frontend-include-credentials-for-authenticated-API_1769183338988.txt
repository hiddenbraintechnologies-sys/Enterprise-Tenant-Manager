✅ Fix (Frontend): include credentials for authenticated APIs
Patch rule

Public endpoints (like /api/public/rollouts) → credentials: "omit"

Logged-in endpoints (like /api/marketplace/...) → credentials: "include"

Files to fix (99%):

client/src/pages/marketplace.tsx (or client/src/pages/marketplace/index.tsx)

client/src/components/marketplace/install-addon-modal.tsx

client/src/lib/api.ts / client/src/lib/apiClient.ts (whatever your main API wrapper is)

Quick fix code (use this pattern)
✅ If you are using fetch directly in the modal:
const res = await fetch(`/api/marketplace/addons/${addonKey}/purchase`, {
  method: "POST",
  credentials: "include", // ✅ THIS FIXES 401 (cookie session)
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ billingCycle: selectedCycle }),
});

✅ If you have a shared API helper, enforce it there:

client/src/lib/api.ts

export async function apiFetch(input: RequestInfo, init: RequestInit = {}) {
  const res = await fetch(input, {
    ...init,
    credentials: "include", // ✅ default for app APIs
    headers: {
      "Content-Type": "application/json",
      ...(init.headers || {}),
    },
  });

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`${res.status} ${text}`);
  }

  return res.json();
}


Then in marketplace:

await apiFetch(`/api/marketplace/addons/${addonKey}/purchase`, {
  method: "POST",
  body: JSON.stringify({ billingCycle }),
});

✅ Fix (Backend): if your marketplace route uses token-only middleware

If your server marketplace purchase route uses middleware that expects Bearer token only, but your login uses cookie session, it’ll still 401.

So ensure marketplace routes use the same “hybrid auth” middleware you used earlier for projects/timesheets.

Check one of these files:

server/routes.ts

server/routes/marketplace.ts

server/middleware/auth-middleware.ts

And make sure the purchase route is protected by:

requireAuth that supports session + token
(or equivalent)

Example:

router.post("/api/marketplace/addons/:addonKey/purchase", requireAuthHybrid, handler);

The fastest way to confirm the cause (30 seconds)

In DevTools, click the purchase request and verify:

Request Headers should include either:

✅ Cookie: ... (session auth)
OR
✅ Authorization: Bearer ... (token auth)

If both are missing → frontend fix is enough.

Replit prompt (paste this to get it fixed properly)

PROMPT:
Fix Marketplace add-on purchase 401.
When clicking “Install Add-on”, the network request purchase returns 401 Unauthorized. Ensure authenticated marketplace API calls include auth (cookie session or bearer token). Do NOT break public rollouts fetch which uses credentials: "omit".

Tasks:

Find the code that calls /api/marketplace/.../purchase (modal/page).

Ensure it uses the shared API client that includes credentials:"include" OR include it in the fetch options.

Verify other app calls still work and public endpoints remain credential-less.

On backend, confirm marketplace purchase route uses the hybrid auth middleware (session OR token) consistent with the rest of the dashboard.

Add clear error UI for 401: “Session expired. Please sign in again.” with a Sign In button.

Return:

exact files modified

exact code changes

how to verify in Chrome DevTools (Cookie/Authorization present)